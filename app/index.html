<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n L√Ω ·∫¢nh (Mobile & PC)</title>
    <style>
        /* --- 1. C·∫§U H√åNH CHUNG --- */
        :root {
            --primary: #007bff; /* M√†u ch·ªß ƒë·∫°o */
            --bg: #f4f7f6;
            --white: #ffffff;
            --text: #333;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px; /* Gi·∫£m padding tr√™n mobile */
        }
        
        /* Layout linh ho·∫°t: PC chia c·ªôt, Mobile x·∫øp ch·ªìng */
        .container {
            display: flex;
            flex-wrap: wrap; /* T·ª± ƒë·ªông xu·ªëng d√≤ng khi m√†n h√¨nh nh·ªè */
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .box {
            background: var(--white);
            padding: 15px;
            border-radius: 10px; /* Bo tr√≤n m·ªÅm m·∫°i h∆°n cho gi·ªëng App */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex: 1 1 300px; /* Co gi√£n t·ªëi thi·ªÉu 300px */
            width: 100%;
        }

        h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.1em; color: #444; }

        /* --- 2. INPUT & BUTTON (T·ªêI ∆ØU C·∫¢M ·ª®NG) --- */
        /* Input to h∆°n ƒë·ªÉ d·ªÖ b·∫•m tr√™n ƒëi·ªán tho·∫°i */
        input, select, textarea {
            width: 100%;
            padding: 12px; /* TƒÉng v√πng ch·∫°m */
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px; /* Size 16px ngƒÉn iOS t·ª± zoom khi nh·∫≠p li·ªáu */
            background: #fff;
        }

        /* N√∫t b·∫•m d·∫°ng kh·ªëi l·ªõn, d·ªÖ ch·∫°m ng√≥n tay */
        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 5px;
            touch-action: manipulation; /* TƒÉng t·ªëc ƒë·ªô ph·∫£n h·ªìi c·∫£m ·ª©ng */
        }
        button:active { background-color: #0056b3; transform: scale(0.98); }

        /* --- 3. B·∫¢NG D·ªÆ LI·ªÜU (CU·ªòN NGANG TR√äN MOBILE) --- */
        .table-responsive {
            width: 100%;
            overflow-x: auto; /* Cho ph√©p cu·ªôn ngang n·∫øu b·∫£ng qu√° r·ªông */
            -webkit-overflow-scrolling: touch; /* Cu·ªôn m∆∞·ª£t tr√™n iOS */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 300px; /* ƒê·∫£m b·∫£o b·∫£ng kh√¥ng b·ªã b√≥p m√©o qu√° m·ª©c */
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
            font-size: 14px;
        }
        th { background-color: #f8f9fa; white-space: nowrap; }

        /* --- 4. TH∆Ø VI·ªÜN ·∫¢NH (GALLERY) --- */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* T·ª± ƒëi·ªÅu ch·ªânh s·ªë c·ªôt */
            gap: 10px;
        }
        .img-card {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            text-align: center;
        }
        .img-card img {
            width: 100%;
            height: 100px; /* ·∫¢nh vu√¥ng v·∫Øn tr√™n mobile */
            object-fit: cover;
            display: block;
        }

        /* --- 5. MODAL (PH√ìNG TO ·∫¢NH) --- */
        .modal {
            display: none;
            position: fixed; z-index: 9999;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.95);
            align-items: center; justify-content: center;
        }
        .modal-content {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* ƒê·∫£m b·∫£o ·∫£nh lu√¥n n·∫±m tr·ªçn trong m√†n h√¨nh ƒëi·ªán tho·∫°i */
        }
        .close-btn {
            position: absolute;
            top: 15px; right: 15px;
            background: rgba(255,255,255,0.2);
            color: white;
            width: 40px; height: 40px;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-size: 24px;
            cursor: pointer;
        }

        /* --- 6. T·ªêI ∆ØU RI√äNG CHO PC (M√ÄN H√åNH L·ªöN) --- */
        @media (min-width: 768px) {
            .container { flex-wrap: nowrap; } /* PC th√¨ chia c·ªôt ngang */
            .box { margin-bottom: 0; }
            button { width: auto; padding: 10px 20px; } /* N√∫t tr√™n PC nh·ªè g·ªçn h∆°n */
        }
    </style>
</head>
<body>

    <h2 style="text-align: center; color: var(--primary);">üì± Qu·∫£n L√Ω ·∫¢nh ƒê∆°n H√†ng</h2>

    <div class="container">
        <div class="box">
            <h3>Danh s√°ch ƒê∆°n (Orders)</h3>
            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                <table id="tableOrders">
                    <thead><tr><th>M√£ ƒê∆°n</th><th>Ng√†y t·∫°o</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="box">
            <h3>M√£ h√†ng (Items)</h3>
            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                <table id="tableItems">
                    <thead><tr><th>Item</th><th>Order</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="box">
            <h3>T·∫°o M·ªõi & Upload</h3>
            
            <details open>
                <summary><b>1. T·∫°o ƒê∆°n H√†ng M·ªõi</b></summary>
                <form id="formCreateOrder" style="margin-top: 10px;">
                    <input type="text" name="order_no" placeholder="Nh·∫≠p M√£ ƒê∆°n (VD: O-2025)" required>
                    <button type="submit">L∆∞u ƒê∆°n</button>
                    <div id="resOrder" style="color: green; margin-top: 5px;"></div>
                </form>
            </details>
            <hr>

            <details>
                <summary><b>2. T·∫°o M√£ H√†ng</b></summary>
                <form id="formCreateItem" style="margin-top: 10px;">
                    <select id="selOrderCreate" name="order_no" required><option>ƒêang t·∫£i...</option></select>
                    <input type="text" name="item_code" placeholder="Nh·∫≠p M√£ H√†ng" required>
                    <button type="submit">L∆∞u M√£ H√†ng</button>
                    <div id="resItem" style="color: green; margin-top: 5px;"></div>
                </form>
            </details>
            <hr>

            <details>
                <summary><b>3. Upload ·∫¢nh</b></summary>
                <form id="formUpload" enctype="multipart/form-data" style="margin-top: 10px;">
                    <select id="selOrderUpload" required><option>-- Ch·ªçn ƒê∆°n --</option></select>
                    <select id="selItemUpload" name="item_code" required disabled><option>-- Ch·ªçn M√£ --</option></select>
                    <input type="file" name="file" accept="image/*" required> <button type="submit" style="background: #28a745;">‚¨ÜÔ∏è T·∫£i L√™n</button>
                    <div id="resUpload" style="margin-top: 5px;"></div>
                </form>
            </details>
        </div>
    </div>

    <div class="container">
        <div class="box">
            <h3>Th∆∞ Vi·ªán ·∫¢nh</h3>
            <div style="display: flex; gap: 10px;">
                <select id="selItemView" style="flex:1;">
                    <option value="" disabled selected>-- Ch·ªçn M√£ H√†ng --</option>
                </select>
                <button onclick="loadImages()" style="width: auto;">Xem</button>
            </div>
            <div id="galleryArea" class="gallery" style="margin-top: 15px;">
                <p style="color: #777; font-size: 0.9em;">Ch·ªçn m√£ h√†ng ƒë·ªÉ xem ·∫£nh.</p>
            </div>
        </div>
    </div>

    <div id="lightbox" class="modal" onclick="closeLightbox()">
        <span class="close-btn">&times;</span>
        <img class="modal-content" id="imgExpanded">
    </div>

    <script>
        const formatDate = (str) => new Date(str).toLocaleDateString('vi-VN');

        // LOAD DATA
        async function loadInitialData() {
            try {
                const [orders, items] = await Promise.all([
                    fetch('/api/orders').then(r => r.json()),
                    fetch('/api/items').then(r => r.json())
                ]);

                // Render Table
                document.querySelector('#tableOrders tbody').innerHTML = orders.map(o => `<tr><td>${o.order_no}</td><td>${formatDate(o.created_at)}</td></tr>`).join('');
                document.querySelector('#tableItems tbody').innerHTML = items.map(i => `<tr><td>${i.item_code}</td><td>${i.order_no}</td></tr>`).join('');

                // Render Dropdowns
                const ordOpts = '<option value="" disabled selected>-- Ch·ªçn ƒê∆°n --</option>' + orders.map(o => `<option value="${o.order_no}">${o.order_no}</option>`).join('');
                document.getElementById('selOrderCreate').innerHTML = ordOpts;
                document.getElementById('selOrderUpload').innerHTML = ordOpts;
                
                document.getElementById('selItemView').innerHTML = '<option value="" disabled selected>-- Ch·ªçn M√£ H√†ng --</option>' + 
                    items.map(i => `<option value="${i.item_code}">${i.item_code} (${i.order_no})</option>`).join('');

            } catch (e) { console.error(e); }
        }

        // UPLOAD LOGIC
        document.getElementById('selOrderUpload').onchange = async function() {
            const res = await fetch(`/api/orders/${this.value}/items`);
            const items = await res.json();
            const sel = document.getElementById('selItemUpload');
            sel.innerHTML = items.length ? items.map(i => `<option value="${i.item_code}">${i.item_code}</option>`).join('') : '<option>Kh√¥ng c√≥ m√£</option>';
            sel.disabled = false;
        };

        // SUBMIT FORMS
        const postData = async (url, body, resId) => {
            const div = document.getElementById(resId);
            div.innerText = "ƒêang x·ª≠ l√Ω...";
            try {
                const res = await fetch(url, { method: 'POST', body });
                if(res.ok) { div.innerText = "‚úÖ Th√†nh c√¥ng!"; div.style.color="green"; loadInitialData(); }
                else { const d = await res.json(); div.innerText = "‚ùå " + d.detail; div.style.color="red"; }
            } catch(e) { div.innerText = "‚ùå L·ªói m·∫°ng"; }
        };

        document.getElementById('formCreateOrder').onsubmit = function(e) { e.preventDefault(); postData('/orders', new FormData(this), 'resOrder'); };
        document.getElementById('formCreateItem').onsubmit = function(e) { e.preventDefault(); postData('/items', new FormData(this), 'resItem'); };
        
        document.getElementById('formUpload').onsubmit = async function(e) { 
            e.preventDefault(); 
            const code = document.getElementById('selItemUpload').value;
            const div = document.getElementById('resUpload');
            div.innerText = "‚è≥ ƒêang upload...";
            try {
                const res = await fetch(`/items/${code}/images`, { method: 'POST', body: new FormData(this) });
                if(res.ok) { div.innerHTML = `‚úÖ <a href="${(await res.json()).url}" target="_blank" style="color:blue">Xem ·∫£nh</a>`; if(document.getElementById('selItemView').value===code) loadImages(); }
                else div.innerText = "‚ùå L·ªói upload";
            } catch(e) { div.innerText = "‚ùå L·ªói m·∫°ng"; }
        };

        // GALLERY
        async function loadImages() {
            const code = document.getElementById('selItemView').value;
            const div = document.getElementById('galleryArea');
            div.innerHTML = "ƒêang t·∫£i...";
            const res = await fetch(`/items/${code}/images`);
            const imgs = await res.json();
            div.innerHTML = imgs.length ? imgs.map(img => `
                <div class="img-card" onclick="openLightbox('${img.url}')">
                    <img src="${img.url}">
                </div>`).join('') : '<p>Ch∆∞a c√≥ ·∫£nh</p>';
        }

        // LIGHTBOX
        function openLightbox(src) {
            document.getElementById('lightbox').style.display = 'flex';
            document.getElementById('imgExpanded').src = src;
        }
        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
        }

        loadInitialData();
    </script>
</body>
</html>
