<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω ·∫¢nh ƒê∆°n H√†ng (FastAPI)</title>
    <style>
        /* --- 1. CSS C∆† B·∫¢N --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        h1, h2, h3 { color: #1a73e8; margin-top: 0; }
        
        /* Layout chia c·ªôt */
        .container { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .box {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 300px; /* Xu·ªëng d√≤ng n·∫øu m√†n h√¨nh nh·ªè */
        }

        /* Form elements */
        label { font-weight: 600; font-size: 0.9em; margin-top: 10px; display: block; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }
        input:focus, select:focus { border-color: #1a73e8; outline: none; }

        /* N√∫t b·∫•m */
        button {
            background-color: #1a73e8; color: white; border: none;
            padding: 10px 15px; border-radius: 5px; cursor: pointer;
            font-weight: bold; width: 100%; transition: background 0.2s;
        }
        button:hover { background-color: #1557b0; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* B·∫£ng d·ªØ li·ªáu */
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
        th { background-color: #f8f9fa; color: #555; }

        /* Khu v·ª±c hi·ªÉn th·ªã k·∫øt qu·∫£/L·ªói */
        .result-box {
            margin-top: 10px; padding: 10px; border-radius: 4px;
            font-size: 0.9em; background: #f8f9fa; border: 1px dashed #ccc;
            word-wrap: break-word;
        }

        /* --- 2. CSS DANH S√ÅCH ·∫¢NH (GALLERY) --- */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .img-card { 
            border: 1px solid #ddd; border-radius: 8px; overflow: hidden; 
            background: #fff; text-align: center; padding-bottom: 5px;
        }
        .img-card img {
            width: 100%; height: 100px; object-fit: cover;
            cursor: zoom-in; /* Con tr·ªè h√¨nh k√≠nh l√∫p */
            transition: transform 0.2s;
        }
        .img-card img:hover { transform: scale(1.05); }
        .img-card small { font-size: 0.75em; color: #666; display: block; padding: 0 5px; }
        .img-card a { font-size: 0.75em; text-decoration: none; color: #1a73e8; }

        /* --- 3. CSS MODAL (LIGHTBOX PH√ìNG TO) --- */
        .modal {
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.9); /* N·ªÅn ƒëen m·ªù */
            justify-content: center; align-items: center;
        }
        .modal-content {
            margin: auto; display: block;
            max-width: 90%; max-height: 90vh;
            border: 3px solid #fff;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
            animation: zoom 0.3s;
        }
        /* Hi·ªáu ·ª©ng zoom */
        @keyframes zoom { from {transform:scale(0.1)} to {transform:scale(1)} }
        
        /* N√∫t ƒë√≥ng X */
        .close {
            position: absolute; top: 20px; right: 35px;
            color: #fff; font-size: 40px; font-weight: bold;
            transition: 0.3s; cursor: pointer;
        }
        .close:hover { color: #bbb; }

    </style>
</head>
<body>

    <h1 style="text-align: center;">üöÄ H·ªá Th·ªëng Qu·∫£n L√Ω ·∫¢nh S·∫£n Ph·∫©m</h1>

    <div class="container">
        <div class="box">
            <h3>üì¶ ƒê∆°n h√†ng (Orders)</h3>
            <div style="max-height: 200px; overflow-y: auto;">
                <table id="tableOrders">
                    <thead><tr><th>M√£ ƒê∆°n</th><th>Ng√†y t·∫°o</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="box">
            <h3>üè∑Ô∏è M√£ h√†ng (Items)</h3>
            <div style="max-height: 200px; overflow-y: auto;">
                <table id="tableItems">
                    <thead><tr><th>M√£ h√†ng</th><th>Thu·ªôc Order</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="box">
            <h3>üìù T·∫°o M·ªõi</h3>
            
            <form id="formCreateOrder" style="border-bottom: 1px dashed #ccc; padding-bottom: 15px;">
                <label>1. T·∫°o ƒê∆°n h√†ng m·ªõi:</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" name="order_no" placeholder="V√≠ d·ª•: PO-2024-001" required>
                    <button type="submit" style="width: 80px;">L∆∞u</button>
                </div>
                <div id="resOrder" class="result-box" style="display:none;"></div>
            </form>

            <form id="formCreateItem" style="margin-top: 15px;">
                <label>2. T·∫°o M√£ h√†ng (Ch·ªçn Order tr∆∞·ªõc):</label>
                <select id="selOrderCreate" name="order_no" required>
                    <option value="">-- ƒêang t·∫£i --</option>
                </select>
                <div style="display: flex; gap: 5px;">
                    <input type="text" name="item_code" placeholder="V√≠ d·ª•: ITEM-A-01" required>
                    <button type="submit" style="width: 80px;">L∆∞u</button>
                </div>
                <div id="resItem" class="result-box" style="display:none;"></div>
            </form>
        </div>

        <div class="box">
            <h3>üì• Import H√†ng Lo·∫°t (JSON)</h3>
            <form id="formImport">
                <label>D√°n n·ªôi dung JSON v√†o ƒë√¢y:</label>
                <textarea id="jsonInput" rows="5" placeholder='[{"order_no": "O1", "items": [{"item_code": "I1"}]}]'></textarea>
                <button type="submit" style="background-color: #28a745;">Import D·ªØ Li·ªáu</button>
                <div id="resImport" class="result-box" style="display:none;"></div>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="box" style="flex: 1;">
            <h3>üì§ Upload ·∫¢nh</h3>
            <form id="formUpload" enctype="multipart/form-data">
                <label>B∆∞·ªõc 1: Ch·ªçn ƒê∆°n h√†ng</label>
                <select id="selOrderUpload" required>
                    <option value="" disabled selected>-- Ch·ªçn Order --</option>
                </select>

                <label>B∆∞·ªõc 2: Ch·ªçn M√£ h√†ng</label>
                <select id="selItemUpload" name="item_code" required disabled>
                    <option value="" disabled selected>-- Ch·ªçn Order tr∆∞·ªõc --</option>
                </select>

                <label>B∆∞·ªõc 3: Ch·ªçn File ·∫¢nh</label>
                <input type="file" name="file" accept="image/*" required>
                
                <button type="submit" style="background-color: #e67e22;">‚¨ÜÔ∏è Upload Ngay</button>
                <div id="resUpload" class="result-box" style="display:none;"></div>
            </form>
        </div>

        <div class="box" style="flex: 2;">
            <h3>üñºÔ∏è Th∆∞ Vi·ªán ·∫¢nh</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="selItemView" style="flex: 1;">
                    <option value="" disabled selected>-- Ch·ªçn M√£ h√†ng ƒë·ªÉ xem --</option>
                </select>
                <button onclick="loadImages()" style="width: 100px;">Xem</button>
            </div>
            
            <div id="galleryArea" class="gallery">
                <p style="text-align: center; width: 100%; color: #888;">Vui l√≤ng ch·ªçn m√£ h√†ng ƒë·ªÉ xem ·∫£nh.</p>
            </div>
        </div>
    </div>

    <div id="lightbox" class="modal">
        <span class="close" onclick="closeLightbox()">&times;</span>
        <img class="modal-content" id="imgExpanded">
    </div>

    <script>
        // --- C·∫§U H√åNH & UTILS ---
        const API_PREFIX = "/api"; // Prefix n·∫øu c√≥, hi·ªán t·∫°i d√πng root
        const formatDate = (str) => new Date(str).toLocaleString('vi-VN');

        // --- 1. H√ÄM LOAD D·ªÆ LI·ªÜU CHUNG ---
        async function loadInitialData() {
            try {
                // Fetch Orders
                const resOrd = await fetch('/api/orders');
                const orders = await resOrd.json();
                
                // Fetch Items
                const resItm = await fetch('/api/items');
                const items = await resItm.json();

                // 1.1 Render Table Orders
                const tblOrd = document.querySelector('#tableOrders tbody');
                tblOrd.innerHTML = orders.map(o => `<tr><td>${o.order_no}</td><td>${formatDate(o.created_at)}</td></tr>`).join('');

                // 1.2 Render Table Items
                const tblItm = document.querySelector('#tableItems tbody');
                tblItm.innerHTML = items.map(i => `<tr><td>${i.item_code}</td><td>${i.order_no}</td></tr>`).join('');

                // 1.3 Populate Dropdowns (T·∫°o Item & Upload & View)
                const optsOrd = '<option value="" disabled selected>-- Ch·ªçn Order --</option>' + 
                                orders.map(o => `<option value="${o.order_no}">${o.order_no}</option>`).join('');
                
                document.getElementById('selOrderCreate').innerHTML = optsOrd;
                document.getElementById('selOrderUpload').innerHTML = optsOrd;

                const optsItm = '<option value="" disabled selected>-- Ch·ªçn M√£ h√†ng --</option>' + 
                                items.map(i => `<option value="${i.item_code}">${i.item_code} (thu·ªôc ${i.order_no})</option>`).join('');
                document.getElementById('selItemView').innerHTML = optsItm;

            } catch (err) {
                console.error("L·ªói load data:", err);
            }
        }

        // --- 2. LOGIC DROPDOWN C·∫§P C (Khi ch·ªçn Order -> Load Item) ---
        document.getElementById('selOrderUpload').addEventListener('change', async function() {
            const orderNo = this.value;
            const selItem = document.getElementById('selItemUpload');
            
            selItem.innerHTML = '<option>ƒêang t·∫£i...</option>';
            selItem.disabled = true;

            try {
                const res = await fetch(`/api/orders/${orderNo}/items`);
                const items = await res.json();
                
                if (items.length === 0) {
                    selItem.innerHTML = '<option>Kh√¥ng c√≥ m√£ h√†ng n√†o</option>';
                } else {
                    selItem.innerHTML = items.map(i => `<option value="${i.item_code}">${i.item_code}</option>`).join('');
                    selItem.disabled = false;
                }
            } catch (e) {
                selItem.innerHTML = '<option>L·ªói t·∫£i data</option>';
            }
        });

        // --- 3. X·ª¨ L√ù C√ÅC FORM SUBMIT ---
        // H√†m hi·ªÉn th·ªã th√¥ng b√°o
        function showMsg(elementId, msg, isError = false) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.style.color = isError ? 'red' : 'green';
            el.innerHTML = isError ? `‚ùå ${msg}` : `‚úÖ ${msg}`;
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        // 3.1 T·∫°o Order
        document.getElementById('formCreateOrder').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const res = await fetch('/orders', { method: 'POST', body: formData });
            if (res.ok) { showMsg('resOrder', 'T·∫°o Order th√†nh c√¥ng'); loadInitialData(); e.target.reset(); }
            else { const d = await res.json(); showMsg('resOrder', d.detail, true); }
        };

        // 3.2 T·∫°o Item
        document.getElementById('formCreateItem').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const res = await fetch('/items', { method: 'POST', body: formData });
            if (res.ok) { showMsg('resItem', 'T·∫°o Item th√†nh c√¥ng'); loadInitialData(); e.target.reset(); }
            else { const d = await res.json(); showMsg('resItem', d.detail, true); }
        };

        // 3.3 Import JSON
        document.getElementById('formImport').onsubmit = async (e) => {
            e.preventDefault();
            const jsonText = document.getElementById('jsonInput').value;
            try {
                const jsonData = JSON.parse(jsonText);
                const res = await fetch('/import/orders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ orders: jsonData })
                });
                if(res.ok) { showMsg('resImport', 'Import th√†nh c√¥ng!'); loadInitialData(); }
                else { const d = await res.json(); showMsg('resImport', d.detail || 'L·ªói server', true); }
            } catch (err) {
                showMsg('resImport', 'L·ªói c√∫ ph√°p JSON', true);
            }
        };

        // 3.4 Upload ·∫¢nh
        document.getElementById('formUpload').onsubmit = async (e) => {
            e.preventDefault();
            const itemCode = document.getElementById('selItemUpload').value;
            if(!itemCode) return alert("Vui l√≤ng ch·ªçn M√£ h√†ng!");

            const formData = new FormData(e.target);
            const msgBox = document.getElementById('resUpload');
            msgBox.style.display = 'block'; msgBox.innerHTML = '‚è≥ ƒêang upload...';

            try {
                const res = await fetch(`/items/${itemCode}/images`, { method: 'POST', body: formData });
                const data = await res.json();
                if(res.ok) {
                    msgBox.innerHTML = `‚úÖ Upload xong! <a href="${data.url}" target="_blank">Xem ·∫£nh</a>`;
                    // N·∫øu ƒëang xem ƒë√∫ng item n√†y th√¨ reload gallery
                    if(document.getElementById('selItemView').value === itemCode) loadImages();
                } else {
                    msgBox.innerHTML = `‚ùå L·ªói: ${data.detail}`;
                }
            } catch (err) {
                msgBox.innerHTML = `‚ùå L·ªói k·∫øt n·ªëi`;
            }
        };

        // --- 4. GALLERY & LIGHTBOX ---
        async function loadImages() {
            const itemCode = document.getElementById('selItemView').value;
            const gallery = document.getElementById('galleryArea');
            if(!itemCode) return;

            gallery.innerHTML = '<p>ƒêang t·∫£i ·∫£nh...</p>';
            try {
                const res = await fetch(`/items/${itemCode}/images`);
                const imgs = await res.json();

                if (imgs.length === 0) {
                    gallery.innerHTML = '<p>Ch∆∞a c√≥ ·∫£nh n√†o cho m√£ n√†y.</p>';
                    return;
                }

                // Render ·∫£nh
                gallery.innerHTML = imgs.map(img => `
                    <div class="img-card">
                        <img src="${img.url}" onclick="openLightbox(this.src)" title="Click ƒë·ªÉ ph√≥ng to">
                        <small>ID: ${img.id}</small>
                        <a href="${img.url}" target="_blank">Link g·ªëc</a>
                    </div>
                `).join('');
            } catch (e) {
                gallery.innerHTML = '<p style="color:red">L·ªói t·∫£i ·∫£nh</p>';
            }
        }

        // C√°c h√†m ƒëi·ªÅu khi·ªÉn Modal (Lightbox)
        function openLightbox(src) {
            const modal = document.getElementById("lightbox");
            const modalImg = document.getElementById("imgExpanded");
            modal.style.display = "flex";
            modalImg.src = src;
        }

        function closeLightbox() {
            document.getElementById("lightbox").style.display = "none";
        }

        // ƒê√≥ng khi click ra v√πng ƒëen
        window.onclick = function(event) {
            const modal = document.getElementById("lightbox");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // --- KH·ªûI CH·∫†Y L·∫¶N ƒê·∫¶U ---
        loadInitialData();

    </script>
</body>
</html>
